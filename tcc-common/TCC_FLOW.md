# TCC 分布式事务执行流程图

## 1. 成功场景流程

```
客户端                订单服务                库存服务              数据库
  |                     |                      |                    |
  |--创建订单请求------>|                      |                    |
  |                     |                      |                    |
  |              [生成全局事务ID]               |                    |
  |                     |                      |                    |
  |              ===== Try 阶段 =====           |                    |
  |                     |                      |                    |
  |                     |--创建预订单--------->|------------------>|
  |                     |  (PENDING)           |    INSERT order   |
  |                     |<---------------------|                   |
  |                     |                      |                   |
  |                     |--冻结库存请求------->|                   |
  |                     |                      |--检查可用库存---->|
  |                     |                      |<------------------|
  |                     |                      |--冻结库存-------->|
  |                     |                      | (available-=2)    |
  |                     |                      | (frozen+=2)       |
  |                     |                      |<------------------|
  |                     |                      |--记录冻结信息---->|
  |                     |                      | INSERT frozen     |
  |                     |<--冻结成功-----------|<------------------|
  |                     |                      |                   |
  |             ===== Confirm 阶段 =====        |                   |
  |                     |                      |                   |
  |                     |--确认订单----------->|------------------>|
  |                     |  (CONFIRMED)         | UPDATE order      |
  |                     |<---------------------|<------------------|
  |                     |                      |                   |
  |                     |--确认扣减请求------->|                   |
  |                     |                      |--确认扣减库存---->|
  |                     |                      | (frozen-=2)       |
  |                     |                      | (total-=2)        |
  |                     |                      |<------------------|
  |                     |                      |--更新冻结状态---->|
  |                     |                      | UPDATE frozen     |
  |                     |<--确认成功-----------|<------------------|
  |                     |                      |                   |
  |<--返回订单号--------|                      |                   |
  |                     |                      |                   |
```

## 2. 失败场景流程（库存不足）

```
客户端                订单服务                库存服务              数据库
  |                     |                      |                    |
  |--创建订单请求------>|                      |                    |
  |                     |                      |                    |
  |              [生成全局事务ID]               |                    |
  |                     |                      |                    |
  |              ===== Try 阶段 =====           |                    |
  |                     |                      |                    |
  |                     |--创建预订单--------->|------------------>|
  |                     |  (PENDING)           |    INSERT order   |
  |                     |<---------------------|<------------------|
  |                     |                      |                   |
  |                     |--冻结库存请求------->|                   |
  |                     |                      |--检查可用库存---->|
  |                     |                      |<------------------|
  |                     |                      |   库存不足！      |
  |                     |<--冻结失败-----------|                   |
  |                     |                      |                   |
  |              ===== Cancel 阶段 =====        |                   |
  |                     |                      |                   |
  |                     |--取消订单----------->|------------------>|
  |                     |  (CANCELED)          | UPDATE order      |
  |                     |<---------------------|<------------------|
  |                     |                      |                   |
  |                     |--取消冻结请求------->|                   |
  |                     |                      |--检查冻结记录---->|
  |                     |                      |<------------------|
  |                     |                      | （无需操作）      |
  |                     |<--取消成功-----------|                   |
  |                     |                      |                   |
  |<--返回错误信息------|                      |                   |
  |                     |                      |                   |
```

## 3. 异常场景流程（Confirm阶段失败）

```
客户端                订单服务                库存服务              数据库
  |                     |                      |                    |
  |--创建订单请求------>|                      |                    |
  |                     |                      |                    |
  |              ===== Try 阶段 =====           |                    |
  |                     |                      |                    |
  |                     |--创建预订单--------->✓                    |
  |                     |--冻结库存----------->✓                    |
  |                     |                      |                    |
  |              ===== Confirm 阶段 =====       |                    |
  |                     |                      |                    |
  |                     |--确认订单----------->✓                    |
  |                     |--确认扣减----------->✗ (网络超时/服务异常) |
  |                     |                      |                    |
  |              ===== Cancel 阶段 =====        |                    |
  |                     |                      |                    |
  |                     |--取消订单----------->|------------------>|
  |                     |  (CANCELED)          | UPDATE order      |
  |                     |<---------------------|<------------------|
  |                     |                      |                   |
  |                     |--取消冻结----------->|                   |
  |                     |                      |--恢复库存-------->|
  |                     |                      | (available+=2)    |
  |                     |                      | (frozen-=2)       |
  |                     |                      |<------------------|
  |                     |                      |--更新冻结状态---->|
  |                     |<--取消成功-----------|<------------------|
  |                     |                      |                   |
  |<--返回错误信息------|                      |                   |
  |                     |                      |                   |
```

## 4. 数据状态变化示例

### 初始状态

**库存表 (t_inventory)**
```
product_id | available_stock | frozen_stock | total_stock
---------------------------------------------------------
1001       | 100            | 0            | 100
```

**库存冻结记录表 (t_inventory_frozen)**
```
(空表)
```

### Try 阶段后

**库存表 (t_inventory)**
```
product_id | available_stock | frozen_stock | total_stock
---------------------------------------------------------
1001       | 98             | 2            | 100
```

**库存冻结记录表 (t_inventory_frozen)**
```
transaction_id | branch_id    | product_id | frozen_quantity | status
-----------------------------------------------------------------------
TXN_abc123     | INV_def456   | 1001       | 2              | TRYING
```

**订单表 (t_order)**
```
order_no       | status  | tcc_status | transaction_id
-------------------------------------------------------
ORD_123456789  | PENDING | TRYING     | TXN_abc123
```

### Confirm 阶段后

**库存表 (t_inventory)**
```
product_id | available_stock | frozen_stock | total_stock
---------------------------------------------------------
1001       | 98             | 0            | 98
```

**库存冻结记录表 (t_inventory_frozen)**
```
transaction_id | branch_id    | product_id | frozen_quantity | status
-----------------------------------------------------------------------
TXN_abc123     | INV_def456   | 1001       | 2              | CONFIRMED
```

**订单表 (t_order)**
```
order_no       | status    | tcc_status | transaction_id
---------------------------------------------------------
ORD_123456789  | CONFIRMED | CONFIRMED  | TXN_abc123
```

### Cancel 阶段后（回滚）

**库存表 (t_inventory)**
```
product_id | available_stock | frozen_stock | total_stock
---------------------------------------------------------
1001       | 100            | 0            | 100
```

**库存冻结记录表 (t_inventory_frozen)**
```
transaction_id | branch_id    | product_id | frozen_quantity | status
-----------------------------------------------------------------------
TXN_abc123     | INV_def456   | 1001       | 2              | CANCELED
```

**订单表 (t_order)**
```
order_no       | status   | tcc_status | transaction_id
--------------------------------------------------------
ORD_123456789  | CANCELED | CANCELED   | TXN_abc123
```

## 5. 关键时序点说明

1. **事务ID生成**：在订单服务开始处理时生成全局唯一的事务ID

2. **Try阶段**：
   - 订单服务先创建预订单
   - 再调用库存服务冻结库存
   - 任何一步失败都触发Cancel

3. **Confirm阶段**：
   - 只有Try阶段全部成功才进入
   - 订单服务先确认订单
   - 再调用库存服务确认扣减
   - 失败需要进行补偿回滚

4. **Cancel阶段**：
   - Try或Confirm失败时触发
   - 必须处理空回滚情况
   - 必须保证幂等性

## 6. 并发控制机制

```sql
-- 使用乐观锁防止并发冲突
UPDATE t_inventory 
SET available_stock = available_stock - #{quantity},
    frozen_stock = frozen_stock + #{quantity},
    version = version + 1
WHERE product_id = #{productId}
  AND available_stock >= #{quantity}
  AND version = #{version}  -- 乐观锁版本检查
```

如果 version 不匹配，说明有并发修改，更新失败，需要重试。